---
title: Redis 缩列表
description: 本篇文章将介绍：Redis 缩列表简介、节点的构成、previous_entry_length、encoding、content、连锁更新
categories:
 - Redis
---

> 世界以痛吻我，我仍报之以歌。

## 简介

压缩列表是 Redis 为了节约内存而开发的，是由一系列特殊编码的连续内存块组成的顺序型（sequential）数据结构。一个压缩列表可以包含任意多个节点（entry），每个节点可以保存一个字节数组或者一个整数值。

## 压缩列表节点的构成

每个压缩列表节点可以保存一个字节数组或者一个整数值。

**字节数组可以是以下三种长度的其中一种：**

- 长度小于等于63字节的字节数组
- 长度小于等于16383字节的字节数组
- 长度小于等于4294967295字节的字节数组

**整数值可以是以下六种长度的其中一种：**

- 4位长，介于0至12之间的无符号整数
- 1字节长的有符号整数
- 3字节长的有符号整数
- int16_t类型整数
- int32_t类型整数
- int64_t类型整数

每个压缩列表节点都由 previous_entry_length、encoding、content 三个部分组成。

## previous_entry_length

节点的 previous_entry_length 属性以字节为单位，记录了压缩列表中前一个节点的长度。previous_entry_length 属性的长度可以是1字节或者5字节：

- 如果前一节点的长度小于254字节，那么 previous_entry_length 属性的长度为1字节：前一节点的长度就保存在这一个字节里面
- 如果前一节点的长度大于等于254字节，那么 previous_entry_length 属性的长度为5字节：其中属性的第一字节会被设置为 0xFE（十进制值254），而之后的四个字节则用于保存前一节点的长度

## encoding

节点的 encoding 属性记录了节点的 content 属性所保存数据的类型以及长度：

- 一字节、两字节或者五字节长，值的最高位为00、01或者10的是字节数组编码：这种编码表示节点的 content 属性保存着字节数组，数组的长度由编码除去最高两位之后的其他位记录
- 一字节长，值的最高位以11开头的是整数编码：这种编码表示节点的 content 属性保存着整数值，整数值的类型和长度由编码除去最高两位之后的其他位记录


## content

节点的 content 属性负责保存节点的值，节点值可以是一个字节数组或者整数，值的类型和长度由节点的 encoding 属性决定。

## 连锁更新

每个节点的 previous_entry_length 属性都记录了前一个节点的长度：
- 如果前一节点的长度小于254字节，那么 previous_entry_length 属性需要用1字节长的空间来保存这个长度值
- 如果前一节点的长度大于等于254字节，那么 previous_entry_length 属性需要用5字节长的空间来保存这个长度值

**假设：**

在一个压缩列表中，有多个连续的、长度介于250字节到253字节之间的节点 e1 至 eN。

因为 e1 至 eN 的所有节点的长度都小于254字节，所以记录这些节点的长度只需要1字节长的 previous_entry_length 属性。

**操作**

将一个长度大于等于254字节的新节点 new 设置为压缩列表的表头节点，那么 new 将成为 e1 的前置节点。

**结果**

因为 e1 的 previous_entry_length 属性仅长1字节，它没办法保存新节点 new 的长度，所以程序将对压缩列表执行空间重分配操作，并将 e1 节点的 previous_entry_length 属性从原来的1字节长扩展为5字节长。

e1 原本的长度介于250字节至253字节之间，在为 previous_entry_length 属性新增四个字节的空间之后，e1 的长度就变成了介于254字节至257字节之间，而这种长度使用1字节长的 previous_entry_length 属性是没办法保存的。

为了让 e2 的 previous_entry_length 属性可以记录下e1的长度，程序需要再次对压缩列表执行空间重分配操作，并将 e2 节点的 previous_entry_length 属性从原来的1字节长扩展为5字节长。

扩展 e2 也会引发对 e3 的扩展，而扩展 e3 又会引发对 e4 的扩展……为了让每个节点的 previous_entry_length 属性都符合压缩列表对节点的要求，程序需要不断地对压缩列表执行空间重分配操作，直到 eN 为止。

Redis 将这种在特殊情况下产生的连续多次空间扩展操作称之为“连锁更新”（cascade update）。